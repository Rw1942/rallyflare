---
description: best practices for Cloudflare Workers deployments and GitHub workflows
alwaysApply: false
---


# RallyFlare Deployment Guide

## Microservices Architecture

RallyFlare uses a **microservices architecture** with separate Workers:
- `rally-ingest` - Main service (handles webhooks, dashboard, coordinates other services)
- `rally-ai` - OpenAI API interactions
- `rally-mailer` - Postmark email sending
- `rally-attachments` - R2 file storage

## Settings Cascade Architecture

Rally uses a **three-tier settings hierarchy**:
```
email_settings (per address) → project_settings (global) → hardcoded fallbacks
```

**Tables:**
- `project_settings` - Global defaults (system_prompt, model, temperature, reasoning_effort, etc.)
- `email_settings` - Per-email overrides (any NULL field uses global default)

**Configurable parameters:** `system_prompt`, `model`, `reasoning_effort`, `text_verbosity`, `max_output_tokens`

**Implementation:** `services/ingest/src/utils/settingsMerge.ts` handles the merge logic cleanly.

## Quick Deployment (Microservices)

```bash
# 1. Check what's changed
git status

# 2. Stage all changes
git add .

# 3. Commit with clear message
git commit -m "feat: your feature description

- Bullet point details of what changed
- Include any breaking changes
- Note if database migrations needed"

# 4. Push to GitHub (keeps repo in sync)
git push origin main

# 5. Apply database migrations (if any - manually for now)
# Check migrations/ folder for new .sql files
# Apply each new migration manually:
npx wrangler d1 execute rally-database --remote --command "YOUR SQL HERE"

# 6. Deploy all services
npx wrangler deploy services/ingest/src/index.ts --name rally-ingest && \
npx wrangler deploy services/ai/src/index.ts --name rally-ai && \
npx wrangler deploy services/mailer/src/index.ts --name rally-mailer && \
npx wrangler deploy services/attachments/src/index.ts --name rally-attachments
```

## Important Notes for Microservices

1. **No Root wrangler.toml**: The root directory doesn't have a wrangler.toml, so you must deploy each service individually from its directory or specify the entry point.

2. **Migrations Must Be Manual**: Because the D1 binding is in `services/ingest/wrangler.toml` but migrations are in the root `migrations/` folder, automated migrations don't work. Apply migrations manually using `npx wrangler d1 execute`.

3. **Deploy Order Doesn't Matter**: The services are independent, but it's good practice to deploy dependencies first (mailer, ai, attachments) before the main ingest service.

4. **Check Migrations Already Applied**: If you get "duplicate column" errors, the migration was already applied - that's okay!

## Key Wrangler Commands

**Local Development:**
```bash
npx wrangler dev                    # Run locally, uses .dev.vars for secrets
npx wrangler tail                   # View live logs from deployed Worker
```

**Database Operations:**
```bash
# Query remote database
npx wrangler d1 execute rally-database --remote --command "SELECT * FROM messages LIMIT 5"

# Apply migration from file
npx wrangler d1 execute rally-database --remote --file=migrations/0020_refactor_to_email_settings.sql

# List migrations (doesn't work reliably with our setup - use manual tracking)
npx wrangler d1 migrations list rally-database --remote
```

**Deployment Commands:**
```bash
# Deploy from each service directory
cd services/ingest && wrangler deploy
cd services/ai && wrangler deploy
cd services/mailer && wrangler deploy
cd services/attachments && wrangler deploy

# Or deploy all from root with explicit paths (faster)
wrangler deploy --config services/ingest/wrangler.toml && \
wrangler deploy --config services/ai/wrangler.toml && \
wrangler deploy --config services/mailer/wrangler.toml && \
wrangler deploy --config services/attachments/wrangler.toml
```

**Secrets Management:**
```bash
npx wrangler secret list            # View what secrets are set
npx wrangler secret put SECRET_NAME # Add/update a secret
npx wrangler secret delete SECRET_NAME
```

## Critical Rules

1. **Git First, Deploy Second**: ALWAYS push to GitHub before deploying. This ensures the repo stays in sync with production.

2. **Migrations Before Deploy**: If you created a new migration file in `/migrations`, apply it with the D1 command BEFORE deploying the Worker.

3. **Never Commit Secrets**: Secrets like API keys go in `.dev.vars` (local) or via `wrangler secret put` (production). Never in git.

4. **Database Name is `rally-database`**: Always use this exact name in wrangler commands (with hyphen, not underscore).

5. **Remote Flag for Production**: Use `--remote` flag when working with production database. Without it, commands run against local dev database.

## Common Mistakes to Avoid

- ❌ Running `npx wrangler deploy` without pushing to git first
- ❌ Forgetting to apply migrations before deploying code changes
- ❌ Using `--local` flag when intending to modify production database
- ❌ Deploying without testing locally first with `npx wrangler dev`

## Deployment Checklist

Before running `npx wrangler deploy`:
- [ ] All code changes committed and pushed to GitHub
- [ ] Database migrations applied (if any)
- [ ] Tested locally with `npx wrangler dev`
- [ ] Secrets are configured: `npx wrangler secret list`
- [ ] Wrangler.toml has correct `database_id`

After deploying:
- [ ] Test by sending email to Rally address
- [ ] Check logs: `npx wrangler tail`
- [ ] Verify admin dashboard works

## Configuration Files

- `wrangler.toml` - Worker configuration, database bindings
- `.dev.vars` - Local secrets (gitignored, never commit)
- `migrations/*.sql` - Database schema changes

## Database Operations for Development

### Querying Data

```bash
# View recent messages
npx wrangler d1 execute rally-database --remote --command "SELECT id, from_email, subject, received_at FROM messages ORDER BY received_at DESC LIMIT 10"

# Check table schema
npx wrangler d1 execute rally-database --remote --command "PRAGMA table_info(messages);"
npx wrangler d1 execute rally-database --remote --command "PRAGMA table_info(email_settings);"

# Count inbound vs outbound
npx wrangler d1 execute rally-database --remote --command "SELECT direction, COUNT(*) as count FROM messages GROUP BY direction"

# View email-specific settings
npx wrangler d1 execute rally-database --remote --command "SELECT email_address, model, temperature, reasoning_effort FROM email_settings"

# View global settings
npx wrangler d1 execute rally-database --remote --command "SELECT * FROM project_settings WHERE project_slug='default'"

# Check performance metrics
npx wrangler d1 execute rally-database --remote --command "SELECT AVG(processing_time_ms) as avg_ms, AVG(cost_dollars) as avg_cost FROM messages WHERE direction='inbound'"
```

### Modifying Data

```bash
# Add email-specific settings
npx wrangler d1 execute rally-database --remote --command "INSERT INTO email_settings (email_address, system_prompt, reasoning_effort) VALUES ('support@company.com', 'You are a helpful support assistant', 'medium')"

# Update global settings
npx wrangler d1 execute rally-database --remote --command "UPDATE project_settings SET reasoning_effort='high' WHERE project_slug='default'"

# Clear specific setting override (NULL = use global default)
npx wrangler d1 execute rally-database --remote --command "UPDATE email_settings SET reasoning_effort=NULL WHERE email_address='support@company.com'"

# Delete test messages
npx wrangler d1 execute rally-database --remote --command "DELETE FROM messages WHERE from_email LIKE '%test%'"

# Delete an email setting
npx wrangler d1 execute rally-database --remote --command "DELETE FROM email_settings WHERE email_address='old@company.com'"
```

### Applying Migrations

```bash
# Check what migrations exist
ls -la migrations/

# Apply a specific migration
npx wrangler d1 execute rally-database --remote --file=migrations/0020_refactor_to_email_settings.sql

# If you get "duplicate column" error, the migration was already applied - that's okay!
# Our manual migration process means we track which are applied by checking the schema directly.

# Verify migration applied successfully
npx wrangler d1 execute rally-database --remote --command "PRAGMA table_info(email_settings);"
```

### Local vs Remote Database

```bash
# Work with LOCAL database (for testing)
npx wrangler d1 execute rally-database --command "SELECT COUNT(*) FROM messages"

# Work with REMOTE/PRODUCTION database (requires --remote flag)
npx wrangler d1 execute rally-database --remote --command "SELECT COUNT(*) FROM messages"

# Local database lives at: .wrangler/state/v3/d1/miniflare-D1DatabaseObject/*.sqlite
```

### Useful Development Queries

```bash
# Find messages with high AI costs
npx wrangler d1 execute rally-database --remote --command "SELECT subject, cost_dollars, tokens_input, tokens_output FROM messages WHERE cost_dollars > 0.01 ORDER BY cost_dollars DESC LIMIT 10"

# Check cached token efficiency
npx wrangler d1 execute rally-database --remote --command "SELECT AVG(cached_tokens) as avg_cached, AVG(tokens_input) as avg_input FROM messages WHERE cached_tokens > 0"

# View reasoning token usage
npx wrangler d1 execute rally-database --remote --command "SELECT subject, reasoning_tokens, tokens_output FROM messages WHERE reasoning_tokens IS NOT NULL ORDER BY reasoning_tokens DESC LIMIT 10"

# List all configured email addresses
npx wrangler d1 execute rally-database --remote --command "SELECT email_address FROM email_settings UNION SELECT DISTINCT email_address FROM messages WHERE direction='inbound' ORDER BY email_address"
```

## When Things Break

```bash
# View deployment logs
npx wrangler tail

# Check database is accessible
npx wrangler d1 execute rally-database --remote --command "SELECT COUNT(*) FROM messages"

# Verify secrets are set
npx wrangler secret list

# Test locally before deploying
cd services/ingest && npx wrangler dev

# Check current database schema
npx wrangler d1 execute rally-database --remote --command "SELECT name FROM sqlite_master WHERE type='table'"
```

## Pro Tips

1. **Save frequently-used queries** as shell aliases or scripts
2. **Use `--json` flag** for programmatic access: `npx wrangler d1 execute rally-database --remote --json --command "SELECT * FROM messages LIMIT 1"`
3. **Test migrations locally first** before applying to remote
4. **Keep a migration log** in comments or a separate file tracking which migrations have been applied
5. **Backup before big changes**: Export data with queries, save results

---

**Remember**: Git → Migrations → Deploy. Every time.