# Rally - Email-Native AI Assistant

Rally is an invisible, email-native AI assistant built on Cloudflare Workers. Users interact with Rally entirely through email—no login, no app, just intelligent replies powered by OpenAI.

## Overview

Rally receives emails via Postmark, processes them with OpenAI, and sends contextual replies—all within the same email thread. Everything is logged and searchable in Cloudflare D1.

**Key Features:**
- Receive emails via Postmark inbound webhooks
- Store messages, participants, and metadata in D1
- **Process email content with GPT-5** using OpenAI's Responses API
- Handle forwarded email threads and HTML-only emails
- Send automated replies via Postmark API (preserving email threads)
- **Beautiful admin dashboard** with modern, soft design
- Separate views for incoming messages and outgoing replies
- Real-time statistics and AI processing status
- **Performance metrics tracking** - see processing time, AI response time, and token usage for each message
- **Email-specific AI prompts** - configure different AI behavior for different Rally email addresses
- RESTful API for message management

## Architecture

| Component | Purpose |
|-----------|---------|
| **Cloudflare Worker** | Handles webhooks, OpenAI calls, and Postmark integration |
| **Cloudflare D1** | Stores messages, participants, attachments, and settings |
| **Cloudflare R2** | (Future) Storage for large attachments |
| **Postmark** | Inbound + outbound email handling |
| **OpenAI GPT-5** | LLM processing via Responses API with optimized reasoning effort |

## Setup Steps

### 1. Install Dependencies

```bash
npm install
```

### 2. Create D1 Database

Create the Rally database:

```bash
npx wrangler d1 create rally-database
```

Update the `database_id` in `wrangler.json` with the ID returned from the command above.

### 3. Run Database Migrations

Initialize the database with Rally's schema:

```bash
# For production (remote)
npx wrangler d1 migrations apply rally-database --remote

# For local development
npx wrangler d1 migrations apply rally-database --local
```

**Important:** The database name in wrangler.json is `rally-database` (with hyphen, not underscore).

This creates tables for:
- `messages` - Email messages, AI processing results, message direction (inbound/outbound), performance metrics, and recipient email address
- `participants` - To/Cc/Bcc recipients
- `attachments` - Attachment metadata (R2 storage coming soon)
- `project_settings` - Default AI model configuration and system prompts
- `email_prompts` - Email-specific AI prompts for different Rally addresses

**Performance tracking fields:**
- `processing_time_ms` - Total time from email receipt to reply sent
- `ai_response_time_ms` - Time the OpenAI API took to respond
- `tokens_input` - Number of input tokens sent to OpenAI
- `tokens_output` - Number of output tokens generated by OpenAI

### 4. Configure Secrets

Set your API keys as Worker secrets:

```bash
npx wrangler secret put POSTMARK_TOKEN
# Paste your Postmark server token

npx wrangler secret put OPENAI_API_KEY
# Paste your OpenAI API key
```

For local development, copy `.dev.vars.example` to `.dev.vars`:

```bash
# .dev.vars
POSTMARK_TOKEN=your-postmark-token
OPENAI_API_KEY=your-openai-key
```

### 5. Create R2 Bucket (Optional)

For attachment storage:

```bash
npx wrangler r2 bucket create rally-attachments
```

### 6. Deploy

Deploy the Worker to Cloudflare:

```bash
npx wrangler deploy
```

You'll get a URL like: `https://rallyflare.your-subdomain.workers.dev`

## Deployment Workflow

### Standard Deployment Process

When making changes to Rally, follow this workflow:

1. **Check current status:**
   ```bash
   git status
   ```

2. **Stage your changes:**
   ```bash
   git add .
   ```

3. **Commit with descriptive message:**
   ```bash
   git commit -m "Brief description of changes

   - Detailed bullet points of what changed
   - Include any new features or fixes
   - Mention database changes if applicable"
   ```

4. **Push to repository:**
   ```bash
   git push origin main
   ```

5. **Apply database migrations (if any):**
   ```bash
   npx wrangler d1 migrations apply rally-database --remote
   ```

6. **Deploy Worker:**
   ```bash
   npx wrangler deploy
   ```

### Database Migration Best Practices

- **Always run migrations before deploying** the Worker code
- **Test migrations locally first:** `npx wrangler d1 migrations apply rally-database --local`
- **Use descriptive migration names:** `0006_add_email_specific_prompts.sql`
- **Include rollback information** in migration comments if needed
- **Check migration status:** `npx wrangler d1 migrations list rally-database --remote`

### Git Best Practices

- **Write clear commit messages** that explain what and why
- **Use bullet points** for multiple changes in one commit
- **Keep commits focused** - one feature or fix per commit
- **Test locally** before committing
- **Push frequently** to avoid losing work

### Deployment Checklist

Before deploying to production:

- [ ] All changes committed and pushed to git
- [ ] Database migrations applied to remote database
- [ ] Secrets are set: `npx wrangler secret list`
- [ ] Local testing completed
- [ ] Worker deploys successfully: `npx wrangler deploy`
- [ ] Test the deployment by sending an email to your Rally address
- [ ] Check logs: `npx wrangler tail`

### 7. Configure Postmark Webhook

See [POSTMARK_SETUP.md](./POSTMARK_SETUP.md) for detailed instructions.

**Quick steps:**
1. Log into Postmark dashboard
2. Go to Servers → Your Server → Settings → Inbound
3. Set webhook URL to: `https://your-worker-url.workers.dev/postmark/inbound`
4. Configure your inbound email address or domain

## Admin Dashboard

Rally includes a beautiful, modern dashboard accessible at the root URL of your deployed Worker.

**Features:**
- Clean, soft design with gentle gradients and smooth interactions
- Statistics overview (total messages, received, sent, AI-processed)
- Separate sections for incoming and outgoing messages
- Each message card shows sender, subject, time, AI summary, and recipient email address
- Visual badges for attachments, AI processing, and reply status
- **Performance metrics badges** showing total processing time, AI response time, and token usage
- Click any message to view full details
- Settings page to configure default AI system prompt
- **Email Prompts page** to manage AI behavior for specific email addresses
- Responsive design for desktop, tablet, and mobile

See [DASHBOARD_GUIDE.md](./DASHBOARD_GUIDE.md) for complete design philosophy and user story.

## API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `GET /` | GET | Admin dashboard (HTML) |
| `POST /postmark/inbound` | POST | Receives Postmark webhook payloads |
| `GET /messages` | GET | List all messages (JSON) |
| `GET /messages/:id` | GET | Get message detail with participants |
| `GET /settings` | GET | Settings page (HTML) |
| `POST /settings` | POST | Update Rally's default system prompt |
| `GET /email-prompts` | GET | Email prompts management page (HTML) |
| `POST /email-prompts` | POST | Create new email-specific prompt |
| `PUT /email-prompts/:id` | PUT | Update email-specific prompt |
| `DELETE /email-prompts/:id` | DELETE | Delete email-specific prompt |

## How It Works

1. **Email arrives** at your Rally address (e.g., `support@rallycollab.com`)
2. **Postmark forwards** it to your Worker at `/postmark/inbound`
3. **Worker stores** message data in D1, including the recipient email address
4. **Content extracted** from TextBody, StrippedTextReply, or HtmlBody (handles forwarded emails)
5. **Worker looks up** email-specific prompt for the recipient address, falls back to default if none found
6. **GPT-5 processes** the email with the appropriate prompt for fast, intelligent responses
7. **Worker sends** an intelligent reply via Postmark API (preserving email threads)
8. **Everything logged** in D1 for admin console review with full debugging info

### Email Addressing

Rally uses a smart addressing strategy to maintain clean email threads:

- **From Address**: All outbound emails come from `rally@rallycollab.com` for consistent branding
- **Reply-To Address**: Set to the original Rally inbox the user contacted (e.g., `requests@rallycollab.com`)
- **Threading**: Proper `In-Reply-To` and `References` headers keep conversations organized

This means users see a consistent sender identity, but their replies route back to the correct Rally inbox.

### Email-Specific AI Prompts

Rally supports different AI behavior for different email addresses:

- **Default Prompt**: Configured in Settings page, used as fallback for unknown addresses
- **Email-Specific Prompts**: Configured in Email Prompts page, override default for specific addresses
- **Automatic Detection**: Worker automatically detects recipient address and uses appropriate prompt
- **Example Use Cases**:
  - `support@rallycollab.com` - Customer support assistant with empathetic tone
  - `sales@rallycollab.com` - Sales assistant for lead qualification
  - `feedback@rallycollab.com` - Feedback collector with acknowledgment focus

## Development

Run locally with Wrangler:

```bash
npx wrangler dev
```

This starts a local server with D1 bindings. Use a tool like [ngrok](https://ngrok.com/) to expose localhost for Postmark webhook testing.

View logs:

```bash
npx wrangler tail
```

Query D1 directly:

```bash
# Query remote database
npx wrangler d1 execute rally-database --remote --command "SELECT * FROM messages LIMIT 5"

# Query local database
npx wrangler d1 execute rally-database --local --command "SELECT * FROM messages LIMIT 5"

# Check performance metrics
npx wrangler d1 execute rally-database --remote --command "SELECT subject, processing_time_ms, ai_response_time_ms, tokens_input, tokens_output FROM messages WHERE processing_time_ms IS NOT NULL ORDER BY received_at DESC LIMIT 10"
```

## Project Structure

```
rallyflare/
├── src/
│   ├── index.ts           # Main Worker with webhook handling
│   └── renderHtml.ts      # Dashboard and settings UI rendering
├── migrations/
│   ├── 0001_create_comments_table.sql     # Original template migration
│   ├── 0002_create_rally_tables.sql       # Rally schema
│   ├── 0003_add_message_direction.sql     # Inbound/outbound tracking
│   ├── 0004_update_model_to_gpt4o.sql     # GPT-5 migration
│   └── 0005_add_performance_metrics.sql   # Performance tracking (processing time, tokens)
├── wrangler.json          # Worker configuration (database_name: rally-database)
├── .dev.vars              # Local development secrets (gitignored)
├── POSTMARK_SETUP.md      # Detailed Postmark configuration guide
├── DASHBOARD_GUIDE.md     # Dashboard design and user story
└── README.md              # This file
```

## Configuration

### Default AI Behavior

Customize Rally's default AI behavior through the Settings page at `/settings` or by directly editing the `project_settings` table in D1:

```sql
UPDATE project_settings 
SET system_prompt = 'You are Rally, a helpful assistant...'
WHERE project_slug = 'default';
```

### Email-Specific AI Behavior

Configure different AI behavior for specific email addresses through the Email Prompts page at `/email-prompts` or by directly editing the `email_prompts` table:

```sql
-- Add email-specific prompt
INSERT INTO email_prompts (email_address, system_prompt) 
VALUES ('support@rallycollab.com', 'You are Rally, a customer support assistant...');

-- Update existing prompt
UPDATE email_prompts 
SET system_prompt = 'Updated prompt...'
WHERE email_address = 'support@rallycollab.com';
```

### Model Configuration

Note: GPT-5 uses `reasoning.effort` and `text.verbosity` instead of temperature. These are configured in the Worker code:
- `reasoning.effort: "low"` - Fast responses suitable for email
- `text.verbosity: "low"` - Concise replies

The model is fixed to `gpt-5` and uses the OpenAI Responses API (`/v1/responses` endpoint).

## Next Steps

- [x] Build admin dashboard UI with modern design
- [x] Separate incoming and outgoing message views
- [x] Upgrade to GPT-5 with Responses API
- [x] Handle forwarded email threads and HTML-only emails
- [x] Add comprehensive error logging and debugging
- [x] Add Settings page with AI prompt configuration
- [x] Track performance metrics (processing time, AI response time, token usage)
- [x] Add email-specific AI prompt configuration
- [ ] Add Cloudflare Access authentication
- [ ] Implement R2 attachment storage
- [ ] Add manual re-process/re-send functionality
- [ ] Create multi-tenant project support
- [ ] Replace Postmark with Cloudflare Email Workers
- [ ] Add cost tracking dashboard based on token usage

## Troubleshooting

**Emails not being received?**
- Check Postmark Activity log
- Verify webhook URL in Postmark settings
- Run `npx wrangler tail` to see incoming requests

**Getting "No response generated" from AI?**
- Check logs with `npx wrangler tail` to see the full OpenAI response structure
- Verify email content was extracted (check for "Processing email - Length: X")
- For forwarded emails, confirm HTML extraction is working (look for "Has HTML fallback: true")
- The worker now logs detailed request/response info for debugging

**Forwarded email threads not processing?**
- Fixed in latest version! Worker now extracts content from HTML when TextBody is empty
- Handles HTML-only forwarded emails by stripping HTML tags
- Truncates extremely long threads to 50,000 characters

**OpenAI errors?**
- Verify `OPENAI_API_KEY` is set: `npx wrangler secret list`
- Check your OpenAI API quota/billing
- GPT-5 requires access to the Responses API (`/v1/responses` endpoint)

**Can't send replies?**
- Verify `POSTMARK_TOKEN` is set
- Check sender domain is verified in Postmark
- Ensure outbound message stream is enabled

**Email-specific prompts not working?**
- Check that the email address in `email_prompts` table matches exactly (case-sensitive)
- Verify the email address is being captured correctly in the `messages.email_address` field
- Check Worker logs to see which prompt is being used: `npx wrangler tail`
- Ensure the migration was applied: `npx wrangler d1 migrations apply rally-database --remote`

**Deployment issues?**
- **Migration failed:** Check if tables already exist, use `INSERT OR IGNORE` for sample data
- **Worker won't deploy:** Verify all TypeScript compiles: `npx tsc --noEmit`
- **Database connection errors:** Ensure D1 database ID is correct in `wrangler.json`
- **Secrets missing:** Set required secrets: `npx wrangler secret put POSTMARK_TOKEN`
- **Git conflicts:** Resolve conflicts before deploying: `git status` and `git pull origin main`

## Contributing

This is a proof-of-concept for Rally. Contributions welcome!

## License

MIT

---

## Original Template

This project was bootstrapped from the Cloudflare D1 Template:
- **Template:** [cloudflare/templates/d1-template](https://github.com/cloudflare/templates/tree/main/d1-template)
- **Original Demo:** [https://d1-template.templates.workers.dev](https://d1-template.templates.workers.dev)

The original template demonstrated a simple Worker + D1 setup with a comments table. Rally extends this foundation with email processing, AI integration, and Postmark connectivity.

For the original template documentation and setup, see the [Cloudflare D1 Template](https://github.com/cloudflare/templates/tree/main/d1-template).
